<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:salesforce-composite="http://www.mulesoft.org/schema/mule/salesforce-composite" xmlns:salesforce="http://www.mulesoft.org/schema/mule/salesforce"
	xmlns:ee="http://www.mulesoft.org/schema/mule/ee/core"
	xmlns:batch="http://www.mulesoft.org/schema/mule/batch" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/batch http://www.mulesoft.org/schema/mule/batch/current/mule-batch.xsd
http://www.mulesoft.org/schema/mule/ee/core http://www.mulesoft.org/schema/mule/ee/core/current/mule-ee.xsd
http://www.mulesoft.org/schema/mule/salesforce http://www.mulesoft.org/schema/mule/salesforce/current/mule-salesforce.xsd
http://www.mulesoft.org/schema/mule/salesforce-composite http://www.mulesoft.org/schema/mule/salesforce-composite/current/mule-salesforce-composite.xsd">
	<sub-flow name="credit_detail_impl_batch_sub_flow" doc:id="b691b516-3649-473a-b610-f2f670838ad1" >
	<choice doc:name="Choice" doc:id="27639bdc-8666-4054-9a27-c8e57db75678" >
			<when expression="#[payload !=[]]">
				<logger level="INFO" doc:name="Total Records Logger" doc:id="b719f735-4487-455e-9887-fba3d7a60da4" message="Total Records available: #[sizeOf(payload)]" />
				<ee:transform doc:name="filtering with rebate" doc:id="44e77968-ddfb-45de-987e-67b2f2e1edfd">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
---
(payload) filter ((item, index) -> !isEmpty(item."Rebate_Number__c") )]]></ee:set-payload>
					</ee:message>
					<ee:variables>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Distinct Records Logger" doc:id="26fe0408-2705-4a6f-b47f-d1ff3ae09739" message="Records available with Rebate_NUmber: #[sizeOf(payload)]" />
				<batch:job jobName="myBatcJob" doc:id="f6dc7a0c-c5f0-4474-a33b-1e4b34d3f0fa">
					<batch:process-records >
						<!-- <logger level="INFO" doc:name="Distinct Records Logger" doc:id="58030348-44ae-498c-a947-116ebd8fecbd" message="Records available with Rebate_Number: #[sizeOf(payload)]" /> -->
						<batch:step name="my-batch" doc:id="1b7eac83-09ca-4e76-9572-66341146195a" acceptExpression='payload."Rebate_Number__c" !="" and payload."Rebate_Number__c" != null'>
							<ee:transform doc:name="set line c value" doc:id="c2e5abb4-c634-4229-b2cf-949cf312668d" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="Line__c" ><![CDATA[%dw 2.0
output application/java
---
payload.Line__c as String]]></ee:set-variable>
									<ee:set-variable variableName="Id" ><![CDATA[%dw 2.0
output application/json
var lineC = payload.Line__c as String
---
"select id from Rebate_Credit_Summary__c where Line__c = '$(lineC)'"]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
							<salesforce:query doc:name="select query" doc:id="4e4294c3-dd17-42b3-9d33-927713ea100a" config-ref="Salesforce_Config" target="salesforceId">
								<reconnect count="${max.retries}" frequency="${max.frequency}"/>
								<salesforce:salesforce-query><![CDATA[#[vars.Id]]]></salesforce:salesforce-query>
							</salesforce:query>
							<ee:transform doc:name="request payload" doc:id="3278e048-ceac-4c3b-bf8a-391e41571422" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="sfIdCompositeRequest" ><![CDATA[%dw 2.0
output application/json
---
{ 
  "compositeRequest": 
  [
     ({
      "method": "GET",
      "referenceId": "refAccount",
      "url": "/services/data/v57.0/query/?q=SELECT id from Account where JDE_AddressNumber__c = $(payload.JDE_Account__c)"
    }) if(!isEmpty(payload.JDE_Account__c)),
    ({
      "method": "GET",
      "referenceId": "refRebate",
      "url": "/services/data/v57.0/query/?q=SELECT id from Rebate__c where RebateNumberText__c = '$(payload.Rebate_Number__c)'"
    } ) if(!isEmpty(payload.Rebate_Number__c))
   ]
  }
   ]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
							<salesforce-composite:execute-composite-request doc:name="retrieve sfids" doc:id="67c5dd99-cf25-467d-be32-3e257636abd4" config-ref="Salesforce_Composite_Config" target="compositeResponse">
								<reconnect count="${max.retries}" frequency="${max.frequency}"/>
								<salesforce-composite:request-body ><![CDATA[#[(vars.sfIdCompositeRequest)]]]></salesforce-composite:request-body>
							</salesforce-composite:execute-composite-request>
							<ee:transform doc:name="sfID values" doc:id="c4d22ea1-91b0-47f5-9e5c-406829bf4a2b">
												<ee:message />
												<ee:variables>
													<ee:set-variable variableName="refAccId"><![CDATA[%dw 2.0
output application/json
var refAccResponse = vars.compositeResponse.compositeResponse filter ((item) -> item.referenceId contains "refAccount") default ""
---

refAccResponse.body[0].records
]]></ee:set-variable>
									<ee:set-variable variableName="refRebateId" ><![CDATA[%dw 2.0
output application/json
var refRebateResponse = vars.compositeResponse.compositeResponse filter ((item) -> item.referenceId contains "refRebate") default ""
---

refRebateResponse.body[0].records
]]></ee:set-variable>
												</ee:variables>
											</ee:transform>
							<ee:transform doc:name="composite transform" doc:id="2a0fc057-9c40-4e46-a0a2-67de7fedfe15">
								<ee:message>
									<ee:set-payload resource="dwl/compositeCreditDetailsTransform.dwl" />
								
</ee:message>
							</ee:transform>
							<batch:aggregator doc:name="Batch Aggregator" doc:id="8e33c065-bcb5-42e8-bbff-2f7b8772fef4" size="10">
								<ee:transform doc:name="set composite request" doc:id="5e6c4303-b806-47af-bcbb-b972a71704aa">
										<ee:message>
											<ee:set-payload><![CDATA[output application/json
---
payload map read( $, 'application/json')]]></ee:set-payload>
										</ee:message>
									</ee:transform>
								<parallel-foreach doc:name="Parallel For Each" doc:id="9cb8acda-e14e-48d9-8d4b-e0ec15ba7be3" collection="#[payload]" maxConcurrency="10">
									<salesforce-composite:execute-composite-request doc:name="create/update creditdetails" doc:id="3b1c8c9f-f88d-4e9c-abc3-8b4ab5587c8d" config-ref="Salesforce_Composite_Config" >
										<reconnect frequency="${max.frequency}" count="${max.retries}"/>
									</salesforce-composite:execute-composite-request>
									<choice doc:name="" doc:id="32a6ae87-8c29-4998-b6ac-f9a6dfca3a49">
								<when expression='#[isEmpty((payload.compositeResponse filter ((item) -&gt; item.referenceId contains "refUpdateCreditDetails") default "").body..message[0])]'>
									<ee:transform doc:name="Salesforce Response" doc:id="4f78391a-ea53-4d08-b5c3-93b4bd081e52">
										<ee:message />
										<ee:variables>
											<ee:set-variable variableName="FEPayload"><![CDATA[%dw 2.0
output application/json indent=false
var creditDetailsRef = payload.compositeResponse filter ((item) -> item.referenceId contains "refUpdateCreditDetails") default ""
---
if(creditDetailsRef[0].httpStatusCode == 204)
("updated record succefully") 
else 
("Created record succefully")]]></ee:set-variable>
										</ee:variables>
									</ee:transform>
									<logger level="INFO" doc:name="compositeResponse" doc:id="d65916cc-aa8b-4283-8be4-3c905103dfb8" message="Counter No: #[vars.counter] SFResponse : #[vars.FEPayload]" />
								
</when>
										<otherwise>
									<logger level="INFO" doc:name="sf response" doc:id="eaf12df7-168e-48b0-9828-fc8fc45b2dcf" message='#[{"message":"error while sending to SF","reason":(payload.compositeResponse filter ((item) -&gt; item.referenceId contains "refUpdateCreditDetails") default "").body..message}]' />
								</otherwise>
							</choice>
								</parallel-foreach>
							</batch:aggregator>
							<logger level="INFO" doc:name="btachAggregatorRequest" doc:id="69950dfe-3780-4366-b5ad-e27e3ae2944a" message="before going to btanch aggregator:#[payload]"/>
						
</batch:step>
					</batch:process-records>
				</batch:job>
			</when>
		</choice>
	</sub-flow>
	<!-- <sub-flow name="credit_detail_impl_flowSub_Flow" doc:id="9829b81b-de32-4901-b384-a67c5185cc7a" >
	<choice doc:name="Choice" doc:id="58f743af-d34b-428f-b264-4ec0674093b9" >
			<when expression="#[payload !=[]]">
				<logger level="INFO" doc:name="Total Records Logger" doc:id="6e5335f6-973e-495c-9d10-fe43a79e83a6" message="Total Records available: #[sizeOf(payload)]" />
				<ee:transform doc:name="filtering with rebate" doc:id="8098fded-832a-4688-994b-d3082d1a5387">
					<ee:message>
						<ee:set-payload><![CDATA[%dw 2.0
output application/json
-&#45;&#45;
(payload) filter ((item, index) -> !isEmpty(item."Rebate_Number__c") )]]></ee:set-payload>
					</ee:message>
					<ee:variables>
					</ee:variables>
				</ee:transform>
				<logger level="INFO" doc:name="Distinct Records Logger" doc:id="5496001e-543e-410f-857b-27d74650b2ec" message="Records available with Rebate_Number: #[sizeOf(payload)]" />
				<batch:job jobName="myBatcJob" doc:id="143fb384-0bee-4634-a0ea-02d054377902">
					<batch:process-records >
						<logger level="INFO" doc:name="Distinct Records Logger" doc:id="a118a937-bd4b-4213-8cbf-d2d2058f343e" message="Records available with Rebate_Number: #[sizeOf(payload)]" />
						<batch:step name="my-batch" doc:id="771418b1-9441-4f27-aa51-30db50175a7c" acceptExpression='payload."Rebate_Number__c" !="" and payload."Rebate_Number__c" != null'>
							<ee:transform doc:name="set line c value" doc:id="2c1ee495-1a48-49c3-8df0-91f74abaf3d2" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="Line__c" ><![CDATA[%dw 2.0
output application/java
-&#45;&#45;
payload.Line__c as String]]></ee:set-variable>
									<ee:set-variable variableName="Id" ><![CDATA[%dw 2.0
output application/json
var lineC = payload.Line__c as String
-&#45;&#45;
"select id from Rebate_Credit_Summary__c where Line__c = '$(lineC)'"]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
							<salesforce:query doc:name="select query" doc:id="7268f07d-b486-4181-a290-6ddd16beb3d5" config-ref="Salesforce_Config" target="salesforceId">
								<salesforce:salesforce-query><![CDATA[#[vars.Id]]]></salesforce:salesforce-query>
							</salesforce:query>
							<ee:transform doc:name="Transform Message" doc:id="4e5aeed1-7b46-4c4f-9b11-58ed0ef61662" >
								<ee:message >
								</ee:message>
								<ee:variables >
									<ee:set-variable variableName="sfIdCompositeRequest" ><![CDATA[%dw 2.0
output application/json
-&#45;&#45;
{ 
  "compositeRequest": 
  [
     ({
      "method": "GET",
      "referenceId": "refAccount",
      "url": "/services/data/v57.0/query/?q=SELECT id from Account where JDE_AddressNumber__c = $(payload.JDE_Account__c)"
    }) if(!isEmpty(payload.JDE_Account__c)),
    ({
      "method": "GET",
      "referenceId": "refRebate",
      "url": "/services/data/v57.0/query/?q=SELECT id from Rebate__c where RebateNumberText__c = '$(payload.Rebate_Number__c)'"
    } ) if(!isEmpty(payload.Rebate_Number__c))
   ]
  }
   ]]></ee:set-variable>
								</ee:variables>
							</ee:transform>
							<salesforce-composite:execute-composite-request doc:name="Execute composite request" doc:id="9bca3ec5-6232-461c-af90-6f5e888c20d1" config-ref="Salesforce_Composite_Config" target="compositeResponse">
								<salesforce-composite:request-body ><![CDATA[#[(vars.sfIdCompositeRequest)]]]></salesforce-composite:request-body>
							</salesforce-composite:execute-composite-request>
							<ee:transform doc:name="sfID values" doc:id="d074edb5-6ca3-4bb3-8aff-f1179cd16221">
												<ee:message />
												<ee:variables>
													<ee:set-variable variableName="refAccId"><![CDATA[%dw 2.0
output application/json
var refAccResponse = vars.compositeResponse.compositeResponse filter ((item) -> item.referenceId contains "refAccount") default ""
-&#45;&#45;

refAccResponse.body[0].records
]]></ee:set-variable>
									<ee:set-variable variableName="refRebateId" ><![CDATA[%dw 2.0
output application/json
var refRebateResponse = vars.compositeResponse.compositeResponse filter ((item) -> item.referenceId contains "refRebate") default ""
-&#45;&#45;

refRebateResponse.body[0].records
]]></ee:set-variable>
												</ee:variables>
											</ee:transform>
							<ee:transform doc:name="composite transform" doc:id="e4d72574-7cfb-458c-abfb-2eb225c15c2c">
								<ee:message>
									<ee:set-payload resource="dwl/compositeCreditDetailsTransform.dwl" />
								
</ee:message>
							</ee:transform>
							<batch:aggregator doc:name="Batch Aggregator" doc:id="700e1f6a-1ae8-4c80-8bcd-c2dfb6544b7f" size="10">
								<ee:transform doc:name="set composite request" doc:id="ca53a2d3-264d-46e8-9746-85ca53c1dc02">
										<ee:message>
											<ee:set-payload><![CDATA[output application/json
-&#45;&#45;
payload map read( $, 'application/json')]]></ee:set-payload>
										</ee:message>
									</ee:transform>
								<parallel-foreach doc:name="Parallel For Each" doc:id="48e7ae31-868f-4983-8c99-fbce775c52c0" collection="#[payload]" maxConcurrency="10">
									<salesforce-composite:execute-composite-request doc:name="Execute composite request" doc:id="3c114cd8-7ade-4501-b06d-75fc7cacd24d" config-ref="Salesforce_Composite_Config" />
									<choice doc:name="" doc:id="d7f15b79-4dfe-4caf-861c-8ca26b526a59">
								<when expression='#[isEmpty((payload.compositeResponse filter ((item) -&gt; item.referenceId contains "refUpdateCreditDetails") default "").body..message[0])]'>
									<ee:transform doc:name="Salesforce Response" doc:id="4aca1fbd-8d4b-4f3e-9efe-f096cecb3799">
										<ee:message />
										<ee:variables>
											<ee:set-variable variableName="FEPayload"><![CDATA[%dw 2.0
output application/json indent=false
var creditDetailsRef = payload.compositeResponse filter ((item) -> item.referenceId contains "refUpdateCreditDetails") default ""
-&#45;&#45;
if(creditDetailsRef[0].httpStatusCode == 204)
("updated record succefully") 
else 
("Created record succefully")]]></ee:set-variable>
										</ee:variables>
									</ee:transform>
									<logger level="INFO" doc:name="compositeResponse" doc:id="57c38845-9fe8-46e2-9108-553b72331f6f" message="Counter No: #[vars.counter] SFResponse : #[vars.FEPayload]" />
								
</when>
										<otherwise>
									<logger level="INFO" doc:name="sf response" doc:id="22fee75a-f1cd-4afd-b98c-024e7e8026ab" message='#[{"message":"error while sending to SF","reason":(payload.compositeResponse filter ((item) -&gt; item.referenceId contains "refUpdateCreditDetails") default "").body..message}]' />
								</otherwise>
							</choice>
								</parallel-foreach>
							</batch:aggregator>
							<logger level="INFO" doc:name="btachAggregatorRequest" doc:id="205ca9a9-2dfb-41e6-a962-06368b38517a" message="before going to btanch aggregator:#[payload]"/>
						
</batch:step>
					</batch:process-records>
				</batch:job>
			</when>
			<otherwise >
				<logger level="INFO" doc:name="Logger" doc:id="dba89e56-9cd1-4235-8a63-5f545aafdac4" message='#["\n Payload is NULL"]'/>
			</otherwise>
		</choice>
	</sub-flow> -->
</mule>
